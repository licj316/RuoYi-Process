<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('流程附件')"/>
</head>
<body class="gray-bg">
<input type="hidden" id="procInsId" th:value="${#httpServletRequest.getParameter('procInsId')}"/>
<input type="hidden" id="status" th:value="${#httpServletRequest.getParameter('status')}"/>
<div class="container-div">
    <div class="row">
        <div class="col-sm-12 select-table table-striped">
            <table id="bootstrap-table"></table>
        </div>
    </div>
</div>
<div id="fileUploadWin" style="display: none">
    <form class="form-horizontal m" id="attachFileUploadForm">
        <div class="form-group">
            <label class="col-sm-3 control-label">附件分类：</label>
            <div class="col-sm-8">
                <span id="attachTypeField" style="color: red"></span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">上传文件：</label>
            <div class="col-sm-8">
                <input class="form-control" type="file" name="attachFile" required/>
            </div>
        </div>
    </form>
</div>
<th:block th:include="include :: footer"/>
<script th:inline="javascript">
    var prefix = ctx + "flowAttachment";
    var procInsId = $("#procInsId").val();
    var status = $("#status").val();
    $(function () {
        var options = {
            url: prefix + "/listDetail?procInsId=" + procInsId,
            sortName: "createTime",
            sortOrder: "desc",
            modalName: "参数",
            onLoadSuccess: function (data) {
                let rows = data.rows;
                let attachTypeVal = "";
                let rowspanStartIndex = 0;
                let rowspanNum = 0;
                let rowspanArr = new Array();
                for (let i = 0; i < rows.length; i++) {
                    let attachType = rows[i]['attachType'];
                    if (attachTypeVal !== attachType) {
                        rowspanNum = i - rowspanStartIndex;
                        // console.info(rowspanStartIndex);
                        // console.info(rowspanNum);
                        attachTypeVal = attachType;
                        if (i != 0) {
                            rowspanArr.push(new Array(rowspanStartIndex, rowspanNum));
                            rowspanStartIndex = i;
                        }
                    }
                }
                rowspanNum = rows.length - rowspanStartIndex;
                rowspanArr.push(new Array(rowspanStartIndex, rowspanNum));
                // console.info(rowspanArr)
                for(let i = 0; i < rowspanArr.length; i++) {
                    $.btTable.bootstrapTable('mergeCells', {
                        index: rowspanArr[i][0],
                        field: 'attachType',
                        colspan: 1,
                        rowspan: rowspanArr[i][1]
                    })
                    $.btTable.bootstrapTable('mergeCells', {
                        index: rowspanArr[i][0],
                        field: 'flowAttachmentId',
                        colspan: 1,
                        rowspan: rowspanArr[i][1]
                    })
                }
            },
            columns: [{
                checkbox: true
            },
                {
                    field: 'num',
                    title: '序号',
                    formatter: function (value, row, index) {
                        return index + 1;
                    }
                },
                {
                    field: 'attachType',
                    title: '附件类型'
                },
                {
                    field: 'flowAttachmentId',
                    title: '上传',
                    formatter: function (value, row, index) {
                        // console.info(row);
                        var actions = [];
                        if('VIEW' !== status) {
                            actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="showUploadModal(\'' + value + '\', \'' + row.attachType + '\')">上传</a>');
                        }
                        return actions.join('');
                    }
                },
                {
                    field: 'fileName',
                    title: '文件名称'
                },
                {
                    field: 'fileType',
                    title: '文件类型'
                },
                {
                    field: 'fileSize',
                    title: '文件大小'
                },
                {
                    field: 'createByName',
                    title: '上传人'
                },
                {
                    field: 'createTime',
                    title: '上传时间'
                },
                {
                    field: 'flowAttachmentDetailId',
                    title: '操作',
                    align: 'center',
                    formatter: function (value, row, index) {
                        if (row.flowAttachmentDetailId) {
                            var actions = [];
                            actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="viewAttachment(\'' + value + '\', \'' + row.fileTYpe + '\')">' + '预览' + '</a>&nbsp;');
                            actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="downloadAttachment(\'' + value + '\', \'' + row.fileTYpe + '\')">' + '下载' + '</a>&nbsp;');
                            if('VIEW' !== status) {
                                actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="deleteAttachment(\'' + value + '\')">' + '删除' + '</a>');
                            }
                            return actions.join('');
                        } else {
                            return '';
                        }
                    }
                }]
        };
        $.table.init(options);
    });

    function showUploadModal(flowAttachmentId, attachType) {
        $("#attachTypeField").text(attachType);
        layer.open({
            type: 1,
            title: "上传附件",
            area: ['800px', '600px'],
            content: $("#fileUploadWin"),
            btn: ['确定', '取消'],
            btn1: async function (index) {
                let res = await uploadFile(flowAttachmentId);
                if (res) {
                    $.modal.msg("上传【" + attachType + "】成功！");
                } else {
                    $.modal.msg("上传【" + attachType + "】失败！");
                }
                $.table.refresh();
                layer.close(index);
            },
            success: function (layero) {
                layer.setTop(layero);
            }
        });
    }

    async function uploadFile(flowAttachmentId) {
        let files = $("input[name='attachFile']")[0].files;
        if (files.length == 0) {
            $.modal.alert("请选择要上传的文件！");
            return;
        }

        let config = {
            //添加请求头
            headers: {
                "Content-Type": "multipart/form-data"
            },
            //添加上传进度监听事件
            onUploadProgress: e => {
                var completeProgress = ((e.loaded / e.total * 100) | 0) + "%";
                console.log(completeProgress);
                // item.uploadPercentage = completeProgress;
            }
        };

        let param = new FormData();
        param.append("flowAttachmentId", flowAttachmentId);
        param.append("file", files[0]);

        let res = await axios.post('/flowAttachment/upload', param, config);
        let data = res.data;
        if (data.code == 0) {
            return true;
        } else {
            return false;
        }
    }

    function viewAttachment(flowAttachmentDetailId, fileType) {
        if('pic' === fileType) {
            // TODO 预览图片
        }
    }

    function downloadAttachment(flowAttachmentDetailId) {
        // TODO 下载附件
    }

    function deleteAttachment(flowAttachmentDetailId) {
        axios.delete('/flowAttachment/delete/' + flowAttachmentDetailId).then(res => {
            console.info(res);
            let data = res.data;
            if(data.code == 0) {
                $.modal.msg('删除成功！');
            } else {
                $.modal.msg('删除失败！');
            }
            $.table.refresh();
        })
    }
</script>
</body>
</html>