<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header(${title})"/>
    <th:block th:include="include :: datetimepicker-css"/>
    <th:block th:include="include :: select2-css"/>
</head>
<body class="gray-bg">
<input type="hidden" id="flow_taskId" th:value="${flow.taskId}"/>
<input type="hidden" id="flow_taskName" th:value="${flow.taskName}"/>
<input type="hidden" id="flow_taskDefKey" th:value="${flow.taskDefKey}"/>
<input type="hidden" id="flow_procInsId" th:value="${flow.procInsId}"/>
<input type="hidden" id="flow_procDefId" th:value="${flow.procDefId}"/>
<input type="hidden" id="flow_procDefKey" th:value="${flow.procDefKey}"/>
<input type="hidden" id="flow_businessId" th:value="${flow.businessId}"/>
<input type="hidden" id="flow_comment" th:value="${flow.comment}"/>

<input type="hidden" id="flow_edit_status" th:value="${status}"/>

<div class="container-div">
    <!-- 流程页面按钮区域 -->
    <div id="container">
        <!-- 审批意见 -->
        <!--        <div class="row comment-box" id="replyOpinion" th:if="${#strings.equals(status, 'AUDIT')}">-->
        <!--            <label class="control-label col-sm-12" id="replyOpinionName">审批意见</label>-->
        <!--            <div class="col-sm-12">-->
        <!--                <textarea class="form-control required" name="flowComment" rows="3" style="resize: none"></textarea>-->
        <!--            </div>-->
        <!--        </div>-->
        <!-- 按钮区域 -->
        <div class="footer-btns">
            <button th:if="${#strings.equals(status, 'EDIT')}" class="btn btn-primary " type="button"
                    onclick="handleSave()"><i class="fa fa-check"></i>&nbsp;保存
            </button>
            <button th:if="${#strings.equals(status, 'EDIT')}" class="btn btn-primary " type="button"
                    onclick="handleSave()"><i class="fa fa-check"></i>&nbsp;发起任务
            </button>
            <button th:if="${#strings.equals(status, 'AUDIT')}" class="btn btn-primary " type="button"
                    onclick="handleSubmit()"><i class="fa fa-check"></i>&nbsp;<span id="flowAgreeButtonName">提交</span>
            </button>
            <button th:if="${#strings.equals(status, 'AUDIT')}" class="btn btn-danger " type="button"
                    onclick="handleReject()"><i class="fa fa-times"></i>&nbsp;<span
                    id="flowRefuseButtonName">拒绝</span></button>
            <button th:if="${#strings.equals(status, 'AUDIT')}" class="btn btn-warning " type="button"
                    onclick="handleBackToStep()" style="display: none">
                <i class="fa fa-undo"></i>&nbsp;
                <span id="callBackTypeText">驳回</span><!-- 自由回退 -->
            </button>
            <!-- v-if="extensionProperty.multiInstanceNode && extensionProperty.addMultiInstance" -->
            <div th:if="${#strings.equals(status, 'AUDIT')}" onclick="handleAddMultiInstance()"
                 class="btn btn-sm btn-warning">
                <i class="fa fa-exchange"></i>&nbsp;加签
            </div>
            <!-- th:if="${extensionProperty.connectionCallBack}" -->
            <button th:if="${#strings.equals(status, 'AUDIT')}" class="btn btn-warning " type="button"
                    onclick="handleConnectionCallBackSave(false)">
                <i class="fa fa-exchange"></i>&nbsp;驳回
            </button>
            <!-- th:if="${extensionProperty.handwritingSignature}" -->
            <!-- th:if="${flow.handWritingSignatureData==''}" -->
            <!-- <span>查看签字</span>-->
<!--            <button th:if="${#strings.equals(status, 'AUDIT')}" onclick="handleWritingSignature()"-->
<!--                    class="btn btn-sm btn-warning" type="button">-->
<!--                <i class="fa fa-edit"></i>-->
<!--                <span id="writingSignatureBtnText">手写签字</span>-->
<!--            </button>-->
            <button onclick="handleClose()" class="btn btn-sm btn-default" type="button">
                <i class="fa fa-close"></i>关闭页面
            </button>
        </div>
        <ul class="nav nav-tabs" role="tablist" style="margin-top: 5px">
            <li class="active" role="presentation"><a data-toggle="tab" href="#flowMainContainer" role="tab"
                                                      th:text="${title}"></a></li>
            <li role="presentation" th:if="${flow.businessId} ne null"><a data-toggle="tab" href="#informationContainer"
                                                                          role="tab">流转信息</a></li>
            <li role="presentation"><a data-toggle="tab" href="#diagramContainer" role="tab">流程图</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="flowMainContainer" role="tabpanel">
                <div th:replace="${formPage} :: form"></div>
            </div>
            <div class="tab-pane" id="informationContainer" role="tabpanel" th:if="${flow.businessId} ne null">
                <iframe allowtransparency-y="yes" border="0" frameborder="no" height="400px" id="histoicFlowList"
                        marginheight="0" marginwidth="0"
                        scrolling-x="no" scrolling-y="auto" width="100%"></iframe>
            </div>
            <div class="tab-pane" id="diagramContainer" role="tabpanel" style="overflow: auto">
                <img th:src="'/flow/process/resource/read?procDefId=' + ${flow.procDefId} + '&resType=image'"
                     style="margin: 0 auto;display: block;">
            </div>
        </div>
        <div>
            <!-- 选择退回节点 -->
            <div id="callBackNodes" style="display: none;padding: 8px">
                <!-- 审批意见 -->
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5 id="backOpinionName">审批意见</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <textarea class="form-control required" name="flowBackComment" rows="3"
                                  style="resize: none"></textarea>
                    </div>
                </div>
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>选择退回节点</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <div class="col-md-12" style="border: 1px solid #cccccc;" id="backNodeContainer">
                            <div class="col-md-3" style="line-height: 48px;">
                                节点名称：
                            </div>
                            <div class="col-md-9" id="backNodeName" style="line-height: 48px;">
                                领导审批
                            </div>
                            <div class="col-md-3" style="line-height: 48px;">
                                处理人：
                            </div>
                            <div class="col-md-9" id="backNodeAssigneContainer">
                            </div>
                        </div>
                        <p style="margin: 0 0 0px;line-height: 0px;">&nbsp;</p>
                    </div>
                </div>
            </div>
            <div style="display: none;padding: 8px;" id="submitNodeWin">
                <!-- 审批意见 -->
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5 id="replyOpinionName">审批意见</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content">
                        <textarea class="form-control required" name="flowComment" rows="3"
                                  style="resize: none"></textarea>
                    </div>
                </div>
                <!-- 下一步节点 -->
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>下一步节点</h5>
                        <div class="ibox-tools">
                            <a class="collapse-link">
                                <i class="fa fa-chevron-up"></i>
                            </a>
                        </div>
                    </div>
                    <div class="ibox-content" id="nextNodeContainer">
                        <div class="col-md-12" style="border: 1px solid #cccccc;">
                            <div class="col-md-3" style="line-height: 48px;">
                                节点名称：
                            </div>
                            <div class="col-md-9" id="nextNodeName" style="line-height: 48px;">
                                领导审批
                            </div>
                            <div class="col-md-3" style="line-height: 48px;">
                                处理人(<span style="color:red;">多人任一</span>)：
                            </div>
                            <div class="col-md-9" id="nextNodeAssigneContainer" style="line-height: 48px;">
                            </div>
                        </div>
                        <p style="margin: 0 0 0px;line-height: 0px;">&nbsp;</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- 签字区域-->
        <div class="signature" id="signature"></div>
        <div class="navbar-fixed-bottom" id="signatureBtn" style="display: none">
            <div class="footer-btns">
                <div onclick="handleWritingSignatureOk()" class="btn btn-sm btn-primary">确定</div>
                <div onclick="handleWritingSignatureReset()" class="btn btn-sm btn-primary">重写</div>
                <div onclick="handleWritingSignatureChange()" class="btn btn-sm btn-primary">取消</div>
            </div>
        </div>
    </div>
</div>
<th:block th:include="include :: footer"/>
<th:block th:include="include :: datetimepicker-js"/>
<th:block th:include="include :: select2-js"/>
<script th:src="'/plugins/jsignature/jSignature.min.js?_=' + ${productVersion}"></script>
<script th:src="'/plugins/jsignature/jSignature.min.noconflict.js?_=' + ${productVersion}"></script>
<script th:replace="${formPage} :: script"/>
<script th:inline="javascript">
    var prefix = ctx;

    var intViewportHeight = window.innerHeight - 175;

    var flow = {
        taskId: '',
        taskName: '',
        taskDefKey: '',
        procInsId: '',
        procDefId: '',
        procDefKey: '',
        businessId: '',
        comment: '',
        delegateStatus: '',
        backToTaskDefKey: '',
        addMultiInstanceAssignee: '',
        flowNextReviewerAssignee: '',
        handWritingSignatureData: '',
        pass: true,
        turnDown: false
    };

    var extensionProperty = {
        callBackType: "NONE",
        callBackNodes: "",
        callBackNodesDesc: "",
        connectionCallBack: false,
        multiInstanceNode: false,
        addMultiInstance: false,
        delMultiInstance: false,
        delMultiInstanceExecutionIsCompleted: false,
        handwritingSignature: false,
        replyOpinion: false,
        agreeButtonName: "同意",
        refuseButtonName: "拒绝",
        replyOpinionName: "批复意见",
        dynamicFreeChoiceNextReviewerMode: false
    };

    var formDataSubmit = false;
    var boxMainHeight = intViewportHeight;
    var flowEditStatus;

    var signatureInit = false;

    var flowFormData;

    function handleInit() {
        flow.taskId = $("#flow_taskId").val();
        flow.taskName = $("#flow_taskName").val();
        flow.taskDefKey = $("#flow_taskDefKey").val();
        flow.procInsId = $("#flow_procInsId").val();
        flow.procDefId = $("#flow_procDefId").val();
        flow.procDefKey = $("#flow_procDefKey").val();
        flow.businessId = $("#flow_businessId").val();
        flow.comment = $("#flow_comment").val();
        flowEditStatus = $("#flow_edit_status").val();
        setPageData();
        if (flow.businessId != undefined && flow.businessId.length > 0) {
            axios.post("/general/flow/process/loadFormData", {flow: this.flow}).then(function (res) {
                if (res.ok) {
                    flowFormData = res.data;
                    setPageData();
                }
            }).catch(reason => console.log(reason));

        }
        axios.post('/flowTask/getUserTaskExtension', $.param({
            taskDefKey: flow.taskDefKey,
            procDefId: flow.procDefId
        }, {arrayFormat: 'brackets'})).then(res => {
            extensionProperty = res.data;
            var showReplyOpinion = true;
            if (extensionProperty.replyOpinion == false || flowEditStatus == 'EDIT' || flowEditStatus == 'VIEW') {
                //不允许填写意见 或者是 流程发起者步骤
                // vm.boxMainHeight = vm.boxMainHeight + 75;
                showReplyOpinion = false;
            }
            // if (showReplyOpinion) {
            //     vm.boxMainHeight = vm.boxMainHeight - 32;
            // }
            // $("#histoicFlowList").css({height: vm.boxMainHeight + 'px'});
            // $("#diagramTab").css({height: vm.boxMainHeight + 'px'});
            // $("#formBoxMain").css({height: vm.boxMainHeight + 'px'});
        });

        if (handleInitAfter != undefined) {
            handleInitAfter();
        }
        if (flow.businessId != "") {
            var url = "/flowTask/histoicFlow?procInsId=" + flow.procInsId + "&startAct=&endAct=&t=" + new Date().getTime();
            $("#histoicFlowList").attr("src", url);
        }
    }

    handleInit();

    function handleSave() {
        // TODO 保存按钮操作
    }

    // 提交按钮操作方法
    function handleSubmit() {
        flow.pass = true;
        flow.turnDown = false;

        var params = {form: getFormData(), flow: flow};
        // 获取下一步节点信息
        axios.post("/general/flow/process/getNextNode", params).then(res => {
            let nextStepInfo = res.data.data;
            let nodeAssigneHtmlArr = [];
            if (!nextStepInfo.assigne) {
                nodeAssigneHtmlArr.push("未指定");
            } else {
                // TODO 需要拿到下一步处理人列表
                nodeAssigneHtmlArr.push('    <div class="radio check-box">');
                nodeAssigneHtmlArr.push('        <label><input type="radio" checked="" value="option2" name="nextStepAssigne"> <i></i> 星尘</label>');
                nodeAssigneHtmlArr.push('    </div>');
            }
            $("#nextNodeName").html(nextStepInfo.name);
            $("#nextNodeAssigneContainer").html(nodeAssigneHtmlArr.join(""));

            // 显示流程提交窗口
            layer.open({
                type: 1,
                title: "提交下一步",
                area: ['800px', '600px'],
                content: $("#submitNodeWin"),
                btn: ['确定', '取消'],
                btn1: function (index) {
                    if (formDataSubmit == false) {
                        handleDoSaveAudit();
                    } else {
                        $.modal.msg('数据正在提交，请稍候...')
                    }
                    layer.close(index);
                },
                success: function (layero) {
                    layer.setTop(layero);
                }
            });
        });
    }

    // 拒绝按钮操作方法
    function handleReject() {
        $.modal.confirm("确认拒绝并结束流程么?", function () {
            flow.pass = false;
            flow.turnDown = false;
            if (formDataSubmit == false) {
                handleDoSaveAudit();
            } else {
                $.modal.msg('数据正在提交，请稍候...')
            }
        });
    }

            // if (formDataSubmit == false) {
            //     if (extensionProperty.dynamicFreeChoiceNextReviewerMode && flow.delegateStatus == '') {
            //         handleChoiceNextReviewerUser();
            //     } else {
            //         handleDoSaveAudit();
            //     }
            // } else {
            //     $.modal.msg('数据正在提交，请稍候...')
            // }

    function handleDoSaveAudit() {
        var status = handleSaveAuditBefor == undefined || handleSaveAuditBefor();
        if (status) {
            formDataSubmit = true;
            axios.post("/general/flow/process/saveAudit", {
                form: getFormData(),
                flow: flow
            }).then(data => {
                $.modal.alert(data.msg)
                if (data.ok) {
                    setTimeout(function () {
                        window.parent.layer.closeAll()
                    }, 1000);
                } else {
                    fromDataSubmit = false;
                }
            });
        } else {
            console.info("校验失败！")
        }
    }


    function handleChoiceNextReviewerUser() {
        var post = {form: getFormData(), flow: flow};
        axios.post("/general/flow/process/getNextNode", post).then(res => {
            let data = res.data;
            if (data.code == 0) {
                var opt = {
                    option: {
                        url: "/general/flow/process/choiceNextReviewerUser?nextNodeId=" + data.data,
                        method: "post",
                        param: flow,
                        key: "query",
                        checkbox: false,
                        openSearch: false,
                        selectPrimaryKey: "userName",
                        selectPrimaryValues: "",
                        cols: [
                            {field: 'realName', title: '姓名'},
                            {field: 'userName', title: '用户名'},
                            {field: 'deptName', title: '部门'},
                        ],
                    },
                    title: "请选择下一步流程办理人",
                    width: "600px",
                    height: "600px",
                    onOk: function (selectData) {
                        if (selectData.length == 0) {
                            core.warn("请选择下一步流程办理人")
                            return false;
                        }
                        flow.flowNextReviewerAssignee = selectData[0].userName;
                        handleDoSaveAudit();
                        return true;
                    },
                }
                // core.showChoseTableData(opt);
                // TODO 渲染选择下一步审核人弹出层
            } else {
                //下一步不是用户节点，忽略[选择下一步审核人]的操作，直接完成任务
                handleDoSaveAudit();
            }
        });
    }

    function handleBackToStep() {
        if (extensionProperty.callBackType == 'FREE_STEP') {
            // 自由回退
            let backNodeHtmlArr = [];
            let callBackNodes = extensionProperty.callBackNodes.split(",");
            let callBackNodesDesc = extensionProperty.callBackNodesDesc.split(",");
            for(let i = 0; i< callBackNodes.length;i++) {
                // TODO 选择回退节点单选框未添加
                backNodeHtmlArr.push('<div class="col-md-3" style="line-height: 48px;">');
                backNodeHtmlArr.push('    节点名称：');
                backNodeHtmlArr.push('</div>');
                backNodeHtmlArr.push('<div class="col-md-9" id="backNodeName" style="line-height: 48px;">');
                backNodeHtmlArr.push(callBackNodesDesc[i]);
                backNodeHtmlArr.push('</div>');
                backNodeHtmlArr.push('<div class="col-md-3" style="line-height: 48px;">');
                backNodeHtmlArr.push('    处理人：');
                backNodeHtmlArr.push('</div>');
                backNodeHtmlArr.push('<div class="col-md-9" id="backNodeAssigneContainer" style="line-height: 48px;">');
                backNodeHtmlArr.push('暂无')
                backNodeHtmlArr.push('</div>');
            }
            $("#backNodeContainer").html(backNodeHtmlArr.join(""));

            layer.open({
                type: 1,
                title: "请选择回退节点",
                area: ['300px', '150px'],
                content: $("#callBackNodes"),
                btn: ['确定', '取消'],
                btn1: function (index) {
                    // TODO 动态设置选择的节点
                    flow.backToTaskDefKey = 'fillInForm';
                    handleDoBackToStep();
                    layer.close(index);
                },
                success: function (layero) {
                    layer.setTop(layero);
                }
            });
        } else {
            // 划线回退
            handleDoBackToStep()
        }
    }

    function handleDoBackToStep() {
        if (formDataSubmit == false) {
            var status = handleBackToStepBefor == undefined || handleBackToStepBefor();
            if (status) {
                fromDataSubmit = true;
                $.operate.post("${base}/general/flow/process/backToStep", {
                    form: getFormData(),
                    flow: flow,
                }, function (data) {
                    $.modal.alert(data)
                    if (data.ok) {
                        setTimeout(function () {
                            window.parent.layer.closeAll()
                        }, 1000);
                    } else {
                        formDataSubmit = false;
                    }
                }, "JSON");
            } else {
                console.info("校验失败！")
            }
        } else {
            $.modal.msg("数据正在提交，请稍候...")
        }
    }

    function handleAddMultiInstance() {
        $.modal.confirm("确认加签吗？", function () {
            if (formDataSubmit == false) {
                var status = handleAddMultiInstanceBefor == undefined || handleAddMultiInstanceBefor();
                if (status) {
                    // TODO 选择加签人员
                    // core.showSelectUsers({
                    //     option: {
                    //         multipleSelection: false,
                    //     },
                    //     onOk: function (users) {
                    //         if (users.length == 0) {
                    //             core.warn("请选择人员")
                    //             return false;
                    //         }
                    //         formDataSubmit = true;
                    //         flow.addMultiInstanceAssignee = users[0].userName;
                    //         $.post("${base}/general/flow/process/addMultiInstance", {
                    //             form: getFormData(),
                    //             flow: vm.flow,
                    //         }, function (data) {
                    //             core.msg(data);
                    //             if (data.ok) {
                    //                 setTimeout(function () {
                    //                     window.parent.layer.closeAll()
                    //                 }, 1000);
                    //             } else {
                    //                 formDataSubmit = false;
                    //             }
                    //         }, "JSON");
                    //         return true;
                    //     }
                    // });
                } else {
                    console.info("校验失败！")
                }
            } else {
                $.modal.msg("数据正在提交，请稍候...")
            }
        });
    }

    function handleConnectionCallBackSave() {
        if (flow.comment.length == 0) {
            $.modal.alertError("请输入" + this.extensionProperty.replyOpinionName)
            return false;
        }
        $.modal.confirm("确认驳回吗？", function () {
            flow.pass = pass;
            flow.turnDown = true;
            if (fromDataSubmit == false) {
                handleDoSaveAudit();
            } else {
                $.modal.alert("数据正在提交，请稍候...")
            }
        });
    }

    function handleClose() {
        $.modal.closeTab();
        try {
            $.modal.close();
        } catch (e) {
            console.info(e);
        }
    }

    function handleWritingSignature() {
        if (this.signatureInit) {
            signature.show();
        } else {
            signature = $("#signature").jSignature();
            signature.addClass("open");
            this.signatureInit = true;
        }
        $("#signatureBtn").show();
    }

    function getFormData() {
        let elementArr = document.querySelector("#flowMainContainer").querySelectorAll("[name]");
        let data = {};
        elementArr.forEach(ele => {
            let name = ele.getAttribute("name");
            if (name) {
                data[name] = ele.value;
                if ("select-one" === ele.type) {
                    data[name + "Text"] = ele.options[ele.selectedIndex].text;
                }
            }
        });
        return data;
    }

    function setPageData() {
        console.info(flowFormData);
        flowFormData = {
            leaveType: "1",
            title: "我要请假",
            reason: "最近加班太多了",
            startTime: "2020-06-03 12:00",
            endTime: "2020-06-12 12:00",
            totalTime: "",
            totalTimeText: ""
        };
        let elementArr = document.querySelector("#flowMainContainer").querySelectorAll("[name]");
        elementArr.forEach(ele => {
            // console.info(ele);
            // console.info(ele.type);
            let eleName = ele.getAttribute("name");
            switch (ele.type) {
                case 'text':
                case 'textarea':
                    ele.value = flowFormData[eleName];
                    break;
                case 'select-one':
                    $(ele).val(flowFormData[eleName]).trigger('change');
                    break;
                default:
                    ele.value = flowFormData[eleName];
            }
        });
    }
</script>
</body>
</html>